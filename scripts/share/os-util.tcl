package provide OsUtil 1.0
package require CommonUtil

namespace eval ::OsUtil {
  variable chars {abcdefghijklmnopqrstuvwzyzABC:;'<>?,./DEFGHIJKLMNOPQRSTUVWXYZ1234567890~!@#$%^&*()_+{}[]|}
}

proc ::OsUtil::createUserNotLogin {un} {
  if {[catch {exec useradd -M -s /bin/false $un} msg o]} {
    puts $msg
  }
}

proc ::OsUtil::randPass {size} {
  variable chars
  set pchars [list]
  set len [string length $chars]
  for {set x 0} {$x < $size} {incr x} {
   set idx [expr {int(rand()*$len)}]
   lappend pchars [string index $chars $idx]
  }
  return [join $pchars {}]
}

proc ::OsUtil::doCommonTasks {ymlDict rawParamDict} {
  if {[dict exists $ymlDict NameServer]} {
    disableNetworkManager
    changeResolver [dict get $ymlDict NameServer]
  }
  setHostName $ymlDict
}

proc ::OsUtil::changeResolver {resolver} {
  if {! [file exists /etc/resolv.conf.origin]} {
    cp /etc/resolv.conf /etc/resolv.conf.origin
  }
  set fid [open /etc/resolv.conf w]
  puts $fid "# Generated by EasyInstaller"
  puts $fid "nameserver $resolver"
  close $fid
}

proc ::OsUtil::setHostName {ymlDict} {
  if {[dict exists $ymlDict HostName]} {
    exec hostnamectl set-hostname [dict get $ymlDict HostName] --static
  }
}

proc ::OsUtil::disableNetworkManager {} {
  catch {
    exec systemctl stop NetworkManager
    exec systemctl disable NetworkManager
  } msg o
}
